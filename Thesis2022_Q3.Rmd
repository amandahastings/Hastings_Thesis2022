---
title: "Thesis2022_Q3"
author: "Amanda Hastings"
date: "2022-09-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Q3: What are the most prominent factors driving post-fire tree regeneration and community composition? 


```{r}
#Read in data 
ThesisDataRaw <- read.csv("HastingsA_MasterThesisData8.8.22.csv")
TerraData <- read.csv("HastingsA_TerraclimateMaster8.16.csv")
ThesisSeedlingsData <- read.csv("HastingsA_MasterSeedlingsData9.12.22.csv")

#Load libraries
library(tidyverse)
library(dplyr)
library(RColorBrewer)
library(emmeans)
library(multcomp)
library(multcompView)
```

## Formatting raw thesis site data and seedlings data 

```{r}
#Filter to only wanted sites in ThesisData 
ThesisData <- ThesisDataRaw %>% 
  filter(!PlotID %in% c('LS11','HS02','HS12','HS13', 'LS01_MV','LS02_MV','HS01_MV'))

ThesisSeedlings <- ThesisSeedlingsData %>% 
  filter(!PlotID %in% c('LS11','HS02','HS12','HS13'))%>% 
  dplyr::select(!c(Fire_name, regen_radius, regenplot_size_m2, regenplot_size_ha))%>% 
  select_if(~!any(is.na(.)))

ThesisAll1 <- full_join(ThesisData, ThesisSeedlings, by= "PlotID") %>% 
  arrange(PlotID)%>% 
  mutate(forest_type = factor(forest_type))
```

## Terraclimate calculations 

## Annual Climate Variables: VPD and CWD 

```{r}
#vpd.kPa.
#def.mm.
AnnualAvgTerra <- TerraData %>%
  group_by(SiteID) %>% 
  summarize(meanVPD = mean(vpd.kPa.), 
            sdVPD = sd(vpd.kPa.), 
            meanCWD = mean(def.mm.), 
            sdCWD = sd(def.mm.)) 

PostAnnual3yr <- TerraData %>% 
  group_by(SiteID, Year)%>% 
  filter(Year == 2019:2021)%>% 
  group_by(SiteID)%>%
  summarize(mean3yrVPD = mean(vpd.kPa.),
            mean3yrCWD = mean(def.mm.))

AnnualDeviation <- inner_join(AnnualAvgTerra,PostAnnual3yr)%>% 
  mutate("dev3yrVPD" = (mean3yrVPD - meanVPD)/sdVPD)%>% 
  mutate("dev3yrCWD" = (mean3yrCWD - meanCWD)/sdCWD)
```

## Growing Season Climate Variables: Max Temp, Min Temp, Precip, Soil Moisture

```{r}
#tmax.degC. 
#tmin.degC.
#ppt.mm.
#soil.mm.
GrowSeasonAvgTerra <- TerraData %>%
  filter(Month %in% c(4,5,6,7,8,9))%>%
  group_by(SiteID) %>% 
  summarize(meanTmax = mean(tmax.degC.), 
            sdTmax = sd(tmax.degC.), 
            meanTmin = mean(tmin.degC.), 
            sdTmin = sd(tmin.degC.),
            meanPrecip = mean(ppt.mm.),
            sdPrecip = sd(ppt.mm.),
            meanSoil = mean(soil.mm.), 
            sdSoil = sd(soil.mm.)) 

PostGrowTerra3yr <- TerraData %>%
  group_by(SiteID, Year)%>%
  filter(Year == 2019:2021 & Month %in% c(4,5,6,7,8,9))%>%
  group_by(SiteID)%>%
  summarize(mean3yrTmax = mean(tmax.degC.),
            mean3yrTmin = mean(tmin.degC.),
            mean3yrPrecip = mean(ppt.mm.),
            mean3yrSoil = mean(soil.mm.))

GrowDeviation <- inner_join(GrowSeasonAvgTerra,PostGrowTerra3yr)%>%
  mutate("dev3yrTmax" = (mean3yrTmax - meanTmax)/sdTmax)%>% 
  mutate("dev3yrTmin" = (mean3yrTmin - meanTmin)/sdTmin)%>% 
  mutate("dev3yrPrecip" = (mean3yrPrecip - meanPrecip)/sdPrecip)%>%
  mutate("dev3yrSoil"= (mean3yrSoil - meanSoil)/sdSoil)
  
```

## Data frame with deviations 

```{r}
ThesisTerra <- inner_join(AnnualDeviation, GrowDeviation)
 
```

## Full data frame with terraclimate and thesis data

```{r}
# ThesisAll1[order(ThesisAll1$PlotID),]

#### Still need to figure out duplicate rows and NAs
# ThesisAll <- merge(ThesisAll1, ThesisTerra, by.x = "PlotID", by.y = "SiteID", all = T)
  
```

## NMDS response data frame 

```{r}

ThesisNMDSResponse <- ThesisAll1 %>% 
  dplyr::select(PlotID, forest_type, gm_cover, fb_cover, sh_cover, tr_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total)%>% 
  mutate_at(vars(PIPO_total,ABLA_total,PIEN_total), as.numeric)

#Standardize by zscore
z_NMDSResponse <- ThesisNMDSResponse %>% 
  mutate(across(gm_cover:PIEN_total, ~as.numeric(scale(.)), .names = 'z_{col}'))%>% 
  replace(is.na(.),0)%>% 
  dplyr::select(!c(gm_cover, fb_cover, sh_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total))%>% 
  remove_rownames %>% 
  column_to_rownames(var="PlotID")

#Rename columns with species 
z_NMDSResponse1 <- z_NMDSResponse %>% 
    rename(
      "Forbs" = z_fb_cover,
      "Shrubs" = z_sh_cover,
      "POTR" = z_POTR_total,
      "QUGA" = z_QUGA_total,
      "RONE" = z_RONE_total,
      "PIPO" = z_PIPO_total,
      "PSME" = z_PSME_total,
      "ABCO" = z_ABCO_total,
      "PICO" = z_PICO_total,
      "PIFL" = z_PIFL_total,
      "PIAR" = z_PIAR_total,
      "ABLA" = z_ABLA_total,
      "PIEN" = z_PIEN_total)

#Lower Montane NMDS
z_NMDSdf_LowerMontane <- z_NMDSResponse1 %>% 
  filter(forest_type == "Lower Montane")%>% 
  dplyr::select(!c(forest_type, PIAR, ABLA, PIEN)) 
  

#Upper Montane NMDS  
z_NMDSdf_UpperMontane <- z_NMDSResponse1 %>% 
  filter(forest_type == "Upper Montane")%>% 
  dplyr::select(!c(forest_type))

#Subalpine NMDS
z_NMDSdf_Subalpine <- z_NMDSResponse1 %>% 
  filter(forest_type == "Subalpine")%>% 
  dplyr::select(!c(forest_type, QUGA, RONE, PIPO))
  

```

## Overlay predictors data frame 

```{r}
#OVerlay predictors data frame 
OverlayPredictors1 <- ThesisAll1 %>% 
  dplyr::select(property, burn_sev_category, field.elevation..m., slope...., aspect_rescaled, heat_load, canopy_cover, avg_seed_source, conifer_seed_source, bg_cover, lt_cover, wd_cover, rk_cover, total_ba, live_ba, dead_ba)%>% 
  rowwise()%>%
  mutate(barren_cover = sum(c(bg_cover,rk_cover)))%>% 
  mutate(organic_cover = sum(c(lt_cover,wd_cover)))

# z_OverlayPredictors <- OverlayPredictors1
#   mutate(across)

```


## Attempts at NMDS 

```{r}
library(vegan)
library(ggvegan)
library(ggpubr)

#NMDS Lower Montane 
NMDS_LowerMontane <- metaMDS(z_NMDSdf_LowerMontane, distance = "euclidean", autotransform = F)
ordiplot(NMDS_LowerMontane, type="t")
str(NMDS_LowerMontane)
vegan:: stressplot(NMDS_LowerMontane)

#NMDS Upper Montane 
NMDS_UpperMontane <- metaMDS(z_NMDSdf_UpperMontane, distance = "euclidean", k=2, autotransform = F)
ordiplot(NMDS_UpperMontane, type = 't')
str(NMDS_UpperMontane)
vegan:: stressplot(NMDS_UpperMontane)

#NMDS Subalpine 
NMDS_Subalpine <- metaMDS(z_NMDSdf_Subalpine, distance = "euclidean", k=2, autotransform = F)
ordiplot(NMDS_Subalpine, type = 't')
str(NMDS_Subalpine)
vegan:: stressplot(NMDS_Subalpine)

```


```{r}

```




