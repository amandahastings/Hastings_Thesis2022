---
title: "Thesis2022_Q3"
author: "Amanda Hastings"
date: "2022-09-08"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Q3: What are the most prominent factors driving post-fire tree regeneration and community composition? 


```{r}
#Read in data 
ThesisDataRaw <- read.csv("HastingsA_MasterThesisData8.8.22.csv")
TerraData <- read.csv("HastingsA_TerraclimateMaster8.16.csv")
ThesisSeedlingsData <- read.csv("HastingsA_MasterSeedlingsData9.12.22.csv")

#Load libraries
library(tidyverse)
library(dplyr)
library(RColorBrewer)
library(emmeans)
library(multcomp)
library(multcompView)
library(ggthemes)
```

## Formatting raw thesis site data and seedlings data 

```{r}
#Filter to only wanted sites in ThesisData 
ThesisData <- ThesisDataRaw %>% 
  filter(!PlotID %in% c('LS11','HS02','HS12','HS13', 'LS01_MV','LS02_MV','HS01_MV'))

ThesisSeedlings <- ThesisSeedlingsData %>% 
  filter(!PlotID %in% c('LS11','HS02','HS12','HS13'))%>% 
  dplyr::select(!c(Fire_name, regen_radius, regenplot_size_m2, regenplot_size_ha))%>% 
  select_if(~!any(is.na(.)))

ThesisAll1 <- full_join(ThesisData, ThesisSeedlings, by= "PlotID") %>% 
  arrange(PlotID)%>% 
  mutate(forest_type = factor(forest_type))%>% 
  mutate(burn_sev_category = factor(burn_sev_category))
```

## Terraclimate calculations 

## Annual Climate Variables: VPD and CWD 

```{r}
#vpd.kPa.
#def.mm.
AnnualAvgTerra <- TerraData %>%
  group_by(SiteID) %>% 
  summarize(meanVPD = mean(vpd.kPa.), 
            sdVPD = sd(vpd.kPa.), 
            meanCWD = mean(def.mm.), 
            sdCWD = sd(def.mm.)) 

PostAnnual3yr <- TerraData %>% 
  group_by(SiteID, Year)%>% 
  filter(Year == 2019:2021)%>% 
  group_by(SiteID)%>%
  summarize(mean3yrVPD = mean(vpd.kPa.),
            mean3yrCWD = mean(def.mm.))

AnnualDeviation <- inner_join(AnnualAvgTerra,PostAnnual3yr)%>% 
  mutate("dev3yrVPD" = (mean3yrVPD - meanVPD)/sdVPD)%>% 
  mutate("dev3yrCWD" = (mean3yrCWD - meanCWD)/sdCWD)
```

## Growing Season Climate Variables: Max Temp, Min Temp, Precip, Soil Moisture

```{r}
#tmax.degC. 
#tmin.degC.
#ppt.mm.
#soil.mm.
GrowSeasonAvgTerra <- TerraData %>%
  filter(Month %in% c(4,5,6,7,8,9))%>%
  group_by(SiteID) %>% 
  summarize(meanTmax = mean(tmax.degC.), 
            sdTmax = sd(tmax.degC.), 
            meanTmin = mean(tmin.degC.), 
            sdTmin = sd(tmin.degC.),
            meanPrecip = mean(ppt.mm.),
            sdPrecip = sd(ppt.mm.),
            meanSoil = mean(soil.mm.), 
            sdSoil = sd(soil.mm.)) 

PostGrowTerra3yr <- TerraData %>%
  group_by(SiteID, Year)%>%
  filter(Year == 2019:2021 & Month %in% c(4,5,6,7,8,9))%>%
  group_by(SiteID)%>%
  summarize(mean3yrTmax = mean(tmax.degC.),
            mean3yrTmin = mean(tmin.degC.),
            mean3yrPrecip = mean(ppt.mm.),
            mean3yrSoil = mean(soil.mm.))

GrowDeviation <- inner_join(GrowSeasonAvgTerra,PostGrowTerra3yr)%>%
  mutate("dev3yrTmax" = (mean3yrTmax - meanTmax)/sdTmax)%>% 
  mutate("dev3yrTmin" = (mean3yrTmin - meanTmin)/sdTmin)%>% 
  mutate("dev3yrPrecip" = (mean3yrPrecip - meanPrecip)/sdPrecip)%>%
  mutate("dev3yrSoil"= (mean3yrSoil - meanSoil)/sdSoil)
  
```

## Data frame with deviations 

```{r}
ThesisTerra <- inner_join(AnnualDeviation, GrowDeviation)
 
```

## Full data frame with terraclimate and thesis data

```{r}
#Combine field-collected data and terraclimate data
ThesisAll <- merge(ThesisAll1, ThesisTerra, by.x = "PlotID", by.y = "SiteID", all = T)
  
```


## NMDS response data frames relativized by maximum value

```{r}
ThesisNMDSResponse <- ThesisAll1 %>% 
  dplyr::select(PlotID, forest_type, gm_cover, fb_cover, sh_cover, tr_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total)%>% 
  mutate_at(vars(PIPO_total,ABLA_total,PIEN_total), as.numeric)

#Lower Montane max relative df
max_NMDSdf_LowerMontane <- ThesisNMDSResponse %>% 
  filter(forest_type == "Lower Montane")%>%
  filter(!PlotID %in% 'LS02')%>%
  dplyr::select(!c(forest_type, PIPO_total)) %>% 
  dplyr::select(-ABCO_total, -PIFL_total:-PIEN_total) %>%
  remove_rownames %>% 
  column_to_rownames(var="PlotID") %>% 
  decostand(., method = "max") %>% 
  dplyr::select(-tr_cover)%>% 
  rename(
    "Graminoids" = gm_cover,
    "Forbs" = fb_cover,
    "Shrubs" = sh_cover,
    "POTR" = POTR_total,
    "QUGA" = QUGA_total,
    "RONE" = RONE_total,
    "PSME" = PSME_total,
    # "ABCO" = ABCO_total,
    "PICO" = PICO_total
  )
  
#Upper Montane max relative data frame 
max_NMDSdf_UpperMontane <- ThesisNMDSResponse %>% 
  filter(forest_type == "Upper Montane") %>%
  dplyr::select(!c(forest_type, RONE_total, PIPO_total, ABCO_total)) %>% 
  dplyr::select(-PIAR_total:-PIEN_total) %>%
  remove_rownames %>% 
  column_to_rownames(var="PlotID") %>%
  decostand(., method = "max") %>% 
  dplyr::select(-tr_cover)%>% 
  rename(
    "Graminoids" = gm_cover,
    "Forbs" = fb_cover,
    "Shrubs" = sh_cover,
    "POTR" = POTR_total,
    "QUGA" = QUGA_total,
    "PSME" = PSME_total,
    "PICO" = PICO_total,
    "PIFL" = PIFL_total
  ) 

#Subalpine max relative df
max_NMDSdf_Subalpine <- ThesisNMDSResponse %>% 
  filter(forest_type == "Subalpine")%>% 
  dplyr::select(-forest_type, -QUGA_total:-PIPO_total, -ABCO_total, -ABLA_total:-PIEN_total)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")%>% 
  decostand(., method = "max") %>%
  dplyr::select(-tr_cover)%>% 
  rename(
    "Graminoids" = gm_cover,
    "Forbs" = fb_cover,
    "Shrubs" = sh_cover,
    "POTR" = POTR_total,
    "PSME" = PSME_total,
    "PICO" = PICO_total,
    "PIFL" = PIFL_total,
    "PIAR" = PIAR_total
  )
```


## NMDS response data frames by z scores

```{r}
#Lower Montane zscore data frame
z_NMDSdf_LowerMontane <- ThesisNMDSResponse %>% 
  filter(forest_type == "Lower Montane")%>% 
  filter(!PlotID %in% 'LS02')%>%
  dplyr::select(!c(forest_type, PIAR_total, ABLA_total, PIEN_total)) %>% 
  mutate(across(gm_cover:PIFL_total, ~as.numeric(scale(.)), .names = 'z_{col}'))%>% 
  replace(is.na(.),0)%>% 
  remove_rownames %>% 
  column_to_rownames(var="PlotID")%>% 
  dplyr::select(!c(gm_cover:PIFL_total))%>% 
  dplyr::select(!c(z_PIPO_total,z_ABCO_total, z_PIFL_total, z_tr_cover))%>% 
  rename(
    "Graminoids" = z_gm_cover,
    "Forbs" = z_fb_cover,
    "Shrubs" = z_sh_cover,
    "POTR" = z_POTR_total,
    "QUGA" = z_QUGA_total,
    "RONE" = z_RONE_total,
    "PSME" = z_PSME_total,
    "PICO" = z_PICO_total,
  ) 
  
#Upper Montane zscore data frame 
z_NMDSdf_UpperMontane <- ThesisNMDSResponse %>% 
  filter(forest_type == "Upper Montane")%>% 
  dplyr::select(!c(forest_type)) %>% 
  mutate(across(gm_cover:PIFL_total, ~as.numeric(scale(.)), .names = 'z_{col}'))%>% 
  replace(is.na(.),0)%>% 
  remove_rownames %>% 
  column_to_rownames(var="PlotID") %>%
  dplyr::select(!c(gm_cover:PIEN_total))%>% 
  dplyr:: select(!c(z_RONE_total, z_PIPO_total, z_ABCO_total, z_tr_cover)) %>%
  rename(
    "Graminoids" = z_gm_cover,
    "Forbs" = z_fb_cover,
    "Shrubs" = z_sh_cover,
    "POTR" = z_POTR_total,
    "QUGA" = z_QUGA_total,
    "PSME" = z_PSME_total,
    "PICO" = z_PICO_total,
    "PIFL" = z_PIFL_total
  ) 

#Subalpine zscore data frame
z_NMDSdf_Subalpine <- ThesisNMDSResponse %>% 
  filter(forest_type == "Subalpine")%>% 
  dplyr::select(!c(forest_type, QUGA_total, RONE_total, PIPO_total)) %>% 
  mutate(across(where(is.numeric),~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")%>% 
  dplyr::select(!c(gm_cover:PIEN_total))%>% 
  dplyr:: select(!c(z_tr_cover, z_ABCO_total, z_ABLA_total, z_PIEN_total)) %>% 
  rename(
    "Graminoids" = z_gm_cover,
    "Forbs" = z_fb_cover,
    "Shrubs" = z_sh_cover,
    "POTR" = z_POTR_total,
    "PSME" = z_PSME_total,
    "PICO" = z_PICO_total,
    "PIFL" = z_PIFL_total,
    "PIAR" = z_PIAR_total
  )

#Standardize by zscore for each forest type 
# z_NMDSResponse <- ThesisNMDSResponse %>% 
#   mutate(across(gm_cover:PIEN_total, ~as.numeric(scale(.)), .names = 'z_{col}'))%>% 
#   replace(is.na(.),0)%>% 
#   dplyr::select(!c(gm_cover, fb_cover, sh_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total))%>% 
#   remove_rownames %>% 
#   column_to_rownames(var="PlotID")


#Rename columns with species 
# z_NMDSResponse1 <- ThesisNMDSResponse %>% 
#     rename(
#       "Graminoids" = z_gm_cover,
#       "Forbs" = z_fb_cover,
#       "Shrubs" = z_sh_cover,
#       "Seedlings" = z_tr_cover,
#       "POTR" = z_POTR_total,
#       "QUGA" = z_QUGA_total,
#       "RONE" = z_RONE_total,
#       "PIPO" = z_PIPO_total,
#       "PSME" = z_PSME_total,
#       "ABCO" = z_ABCO_total,
#       "PICO" = z_PICO_total,
#       "PIFL" = z_PIFL_total,
#       "PIAR" = z_PIAR_total,
#       "ABLA" = z_ABLA_total,
#       "PIEN" = z_PIEN_total)

```


## Overlay predictors data frames 

```{r}
#OVerlay predictors data frame 
OverlayPredictors1 <- ThesisAll1 %>% 
  # dplyr::select(PlotID, burn_sev_category, forest_type, field.elevation..m., slope...., aspect_rescaled, heat_load, canopy_cover, avg_seed_source, conifer_seed_source, bg_cover, lt_cover, wd_cover, rk_cover, total_ba, live_ba, dead_ba)%>% 
  dplyr::select(PlotID, burn_sev_category, forest_type, aspect_rescaled, heat_load, canopy_cover, conifer_seed_source, bg_cover, lt_cover, wd_cover, rk_cover, total_ba)%>% 
  rowwise()%>%
  mutate(barren_cover = sum(c(bg_cover,rk_cover)))%>% 
  mutate(organic_cover = sum(c(lt_cover,wd_cover)))%>% 
  dplyr::select(!c(bg_cover:rk_cover))

#Overlay Predictors Lower Montane 
OverlayPred_LowerMontane <- OverlayPredictors1 %>% 
  filter(forest_type == "Lower Montane")%>% 
  filter(!PlotID %in% 'LS02')%>%
  dplyr::select(!c(forest_type, barren_cover)) %>% 
  # mutate(across(canopy_cover:organic_cover,~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  # replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")
  # rename("Elevation" = field.elevation..m.,
  #        "Slope" = slope....,
  #        "Aspect" = aspect_rescaled,
  #        "Head Load Index" = heat_load,
  #        "Canopy Cover" = z_canopy_cover,
  #        "Adult Seed Source" = z_avg_seed_source,
  #        "Conifer Seed Source" = z_conifer_seed_source,
  #        "Barren Ground" = z_barren_cover,
  #        "Organic Cover" = z_organic_cover)


#Overlay Predictors Lower Montane 
OverlayPred_UpperMontane <- OverlayPredictors1 %>% 
  filter(forest_type == "Upper Montane")%>% 
  dplyr::select(!c(forest_type, barren_cover)) %>% 
  # mutate(across(canopy_cover:organic_cover,~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  # replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")
  # rename("Elevation" = field.elevation..m.,
  #        "Slope" = slope....,
  #        "Aspect" = aspect_rescaled,
  #        "Head Load Index" = heat_load,
  #        "Canopy Cover" = z_canopy_cover,
  #        "Adult Seed Source" = z_avg_seed_source,
  #        "Conifer Seed Source" = z_conifer_seed_source,
  #        "Barren Ground" = z_barren_cover,
  #        "Organic Cover" = z_organic_cover)



#Overlay Predictors Lower Montane 
OverlayPred_Subalpine <- OverlayPredictors1 %>% 
  filter(forest_type == "Subalpine")%>% 
  dplyr::select(!c(forest_type, canopy_cover, barren_cover)) %>% 
  # mutate(across(avg_seed_source:organic_cover,~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  # replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")
  # rename("Elevation" = field.elevation..m.,
  #        "Slope" = slope....,
  #        "Aspect" = aspect_rescaled,
  #        "Head Load Index" = heat_load,
  #        "Adult Seed Source" = z_avg_seed_source,
  #        "Conifer Seed Source" = z_conifer_seed_source,
  #        "Barren Ground" = z_barren_cover,
  #        "Organic Cover" = z_organic_cover)

```


## NMDS objects

```{r}
library(vegan)
library(ggvegan)
library(ggpubr)

#NMDS Lower Montane 
NMDS_LowerMontane <- metaMDS(max_NMDSdf_LowerMontane, distance = "euclidean", autotransform = F, wascores=T)
ordiplot(NMDS_LowerMontane, type="t", main = "Lower Montane")
str(NMDS_LowerMontane)
vegan:: stressplot(NMDS_LowerMontane)

# plot(NMDS_LowerMontane, type = "n")
# points(NMDS_LowerMontane, display = "sites", cex = 0.8, pch=21, col="red", bg="yellow")
# points(NMDS_LowerMontane, display = "species", cex=0.7, col="blue")


#NMDS Upper Montane 
NMDS_UpperMontane <- metaMDS(max_NMDSdf_UpperMontane, distance = "euclidean", k=2, autotransform = F, wascores = T)
ordiplot(NMDS_UpperMontane, type = 't', main = "Upper Montane")
str(NMDS_UpperMontane)
vegan:: stressplot(NMDS_UpperMontane)

#NMDS Subalpine 
NMDS_Subalpine <- metaMDS(max_NMDSdf_Subalpine, distance = "euclidean", k=2, autotransform = F, wascores = T)
ordiplot(NMDS_Subalpine, type = 't', main = "Subalpine")
str(NMDS_Subalpine)
vegan:: stressplot(NMDS_Subalpine)

```

## Plots with ggvegan autoplot()

```{r}
#Attempts to plot with ggvegan
autoplot(NMDS_LowerMontane)

autoplot(NMDS_UpperMontane)

autoplot(NMDS_Subalpine)

```

## Fit environmental variables 

```{r}

#Lower Montane env fit 
EnvFit_LowerMontane <- envfit(NMDS_LowerMontane, OverlayPred_LowerMontane)
# plot(EnvFit_LowerMontane)
EnvFit_LowerMontane

#Upper Montane env fit 
EnvFit_UpperMontane <- envfit(NMDS_UpperMontane, OverlayPred_UpperMontane)
# plot(EnvFit_UpperMontane)
EnvFit_UpperMontane

#Subalpine env fit 
EnvFit_Subalpine <- envfit(NMDS_Subalpine, OverlayPred_Subalpine)
# plot(EnvFit_Subalpine)
EnvFit_Subalpine
```

## Plots using ggvegan 

## Fitting env fit vectors to plot  

```{r}
#Lower Montane EnvFit df for plotting
LowerMontane.sp.scoresdf <- as.data.frame(scores(NMDS_LowerMontane, display = "sites"))

LowerMontane.env.scoresdf <- as.data.frame(scores(EnvFit_LowerMontane, display = "vectors"))
LowerMontane.env.scoresdf <- cbind(LowerMontane.env.scoresdf, EnvPred = rownames(LowerMontane.env.scoresdf))

#Upper Montane EnvFit df for plotting
UpperMontane.sp.scoresdf <- as.data.frame(scores(NMDS_UpperMontane, display = "sites"))

UpperMontane.env.scoresdf <- as.data.frame(scores(EnvFit_UpperMontane, display = "vectors"))
UpperMontane.env.scoresdf <- cbind(UpperMontane.env.scoresdf, EnvPred = rownames(UpperMontane.env.scoresdf))


#Subalpine EnvFit df for plotting
Subalpine.sp.scoresdf <- as.data.frame(scores(NMDS_Subalpine, display = "sites"))

Subalpine.env.scoresdf <- as.data.frame(scores(EnvFit_Subalpine, display = "vectors"))
Subalpine.env.scoresdf <- cbind(Subalpine.env.scoresdf, EnvPred = rownames(Subalpine.env.scoresdf))
```


## Lower Montane plot 

```{r}
#Fortified ordination - Lower Montane
fort_LowerMontane <- fortify(NMDS_LowerMontane)

library(ggrepel)

#Lower Montane plot
ggplot() +
  geom_point(
    data = subset(fort_LowerMontane, Score == "sites"),
    mapping = aes(x = NMDS1, y = NMDS2),
    colour = "black",
    alpha = 0.5
  ) +
  # geom_text(
  #   data = subset(fort_LowerMontane, Score == "sites"),size = 3,
  #   mapping = aes(label = Label, x = NMDS1 * 1.1, y = NMDS2 * 1.1)
  # ) +
  # ^Adds labels for sites 
  labs(title = "Lower Montane") +
  geom_text(
    data = subset(fort_LowerMontane, Score == 'species', check_overlap = T),
    size = 3.25,
    #Pushes label away from the arrow
    mapping = aes(
      label = Label,
      x = NMDS1 * 1.1,
      y = NMDS2 * 1.1
    )
  ) +
  geom_segment(data = LowerMontane.env.scoresdf, aes(x = 0, xend = NMDS1, y=0, yend = NMDS2, colour = EnvPred),
               arrow = arrow(length = unit(0.025, "npc")),
    size = 0.75)+ 
  # geom_text(data = LowerMontane.env.scoresdf, aes(x=0,y=0, label = str_wrap(EnvPred)))+
  geom_abline(
    #Horizontal line through origin
    intercept = 0,
    slope = 0,
    linetype = "dashed",
    size = 0.5,
    colour = "gray"
  ) +
  geom_vline(
    #Vertical line through origin
    aes(xintercept = 0),
    linetype = "dashed",
    size = 0.5,
    colour = "gray"
  ) +
  theme_few() +
  theme(
    axis.text.x = element_text(size = 9),
    axis.title.x = element_text(size = 11),
    axis.title.y = element_text(size = 11),
    axis.text.y = element_text(size = 8),
    legend.title = element_text(size = 11)
  )
```



## Upper Montane plot 

```{r}
#Fortified ordination - Upper Montane
fort_UpperMontane <- fortify(NMDS_UpperMontane)


#Upper Montane plot
ggplot() +
  geom_point(
    data = subset(fort_UpperMontane, Score == "sites"),
    mapping = aes(x = NMDS1, y = NMDS2),
    colour = "black",
    alpha = 0.5
  ) +
  labs(title = "Upper Montane")+
  geom_text( 
    data = subset(fort_UpperMontane, Score == 'species', check_overlap = T), size = 3.25,
    #Pushes label away from the arrow
    mapping = aes(label = Label, x = NMDS1 * 1.1, y = NMDS2 * 1.1))+
  geom_segment(data = UpperMontane.env.scoresdf, aes(x = 0, xend = NMDS1, y=0, yend = NMDS2, colour = EnvPred),
               arrow = arrow(length = unit(0.025, "npc")),
    size = 0.75)+ 
  geom_abline(
    #Horizontal line through origin
    intercept = 0,
    slope = 0,
    linetype = "dashed",
    size = 0.5,
    colour = "gray"
    
  ) +
  geom_vline(
    #Vertical line through origin
    aes(xintercept = 0),
    linetype = "dashed",
    size = 0.5,
    colour = "gray"
  ) +
  theme_few() +
  theme(
    axis.text.x = element_text(size = 9),
    axis.title.x = element_text(size = 11),
    axis.title.y = element_text(size = 11),
    axis.text.y = element_text(size = 8),
    legend.title = element_text(size = 11)
  )
```

## Subalpine plot 

```{r}
#Fortified ordination - Subalpine
fort_Subalpine <- fortify(NMDS_Subalpine)


#Subalpine plot
ggplot() +
  geom_point(
    data = subset(fort_Subalpine, Score == "sites"),
    mapping = aes(x = NMDS1, y = NMDS2),
    colour = "black",
    alpha = 0.5
  ) +
  labs(title = "Subalpine")+
  geom_text( 
    data = subset(fort_Subalpine, Score == 'species', check_overlap = T), size = 3.25,
    #Pushes label away from the arrow
    mapping = aes(label = Label, x = NMDS1 * 1.1, y = NMDS2 * 1.1))+
  geom_abline(
    #Horizontal line through origin
    intercept = 0,
    slope = 0,
    linetype = "dashed",
    size = 0.5,
    colour = "gray"
    
  ) +
  geom_segment(data = Subalpine.env.scoresdf, aes(x = 0, xend = NMDS1, y=0, yend = NMDS2, colour = EnvPred),
               arrow = arrow(length = unit(0.025, "npc")), 
    size = 0.75)+ 
  geom_vline(
    #Vertical line through origin
    aes(xintercept = 0),
    linetype = "dashed",
    size = 0.5,
    colour = "gray"
  ) +
  theme_few() +
  theme(
    axis.text.x = element_text(size = 9),
    axis.title.x = element_text(size = 11),
    axis.title.y = element_text(size = 11),
    axis.text.y = element_text(size = 8),
    legend.title = element_text(size = 11)
  )
```







