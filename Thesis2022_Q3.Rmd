---
title: "Thesis2022_Q3"
author: "Amanda Hastings"
date: "2022-09-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Q3: What are the most prominent factors driving post-fire tree regeneration and community composition? 


```{r}
#Read in data 
ThesisDataRaw <- read.csv("HastingsA_MasterThesisData8.8.22.csv")
TerraData <- read.csv("HastingsA_TerraclimateMaster8.16.csv")
ThesisSeedlingsData <- read.csv("HastingsA_MasterSeedlingsData9.12.22.csv")

#Load libraries
library(tidyverse)
library(dplyr)
library(RColorBrewer)
library(emmeans)
library(multcomp)
library(multcompView)
```

## Formatting raw thesis site data and seedlings data 

```{r}
#Filter to only wanted sites in ThesisData 
ThesisData <- ThesisDataRaw %>% 
  filter(!PlotID %in% c('LS11','HS02','HS12','HS13', 'LS01_MV','LS02_MV','HS01_MV'))

ThesisSeedlings <- ThesisSeedlingsData %>% 
  filter(!PlotID %in% c('LS11','HS02','HS12','HS13'))%>% 
  dplyr::select(!c(Fire_name, regen_radius, regenplot_size_m2, regenplot_size_ha))%>% 
  select_if(~!any(is.na(.)))

ThesisAll1 <- full_join(ThesisData, ThesisSeedlings, by= "PlotID") %>% 
  arrange(PlotID)%>% 
  mutate(forest_type = factor(forest_type))%>% 
  mutate(burn_sev_category = factor(burn_sev_category))
```

## Terraclimate calculations 

## Annual Climate Variables: VPD and CWD 

```{r}
#vpd.kPa.
#def.mm.
AnnualAvgTerra <- TerraData %>%
  group_by(SiteID) %>% 
  summarize(meanVPD = mean(vpd.kPa.), 
            sdVPD = sd(vpd.kPa.), 
            meanCWD = mean(def.mm.), 
            sdCWD = sd(def.mm.)) 

PostAnnual3yr <- TerraData %>% 
  group_by(SiteID, Year)%>% 
  filter(Year == 2019:2021)%>% 
  group_by(SiteID)%>%
  summarize(mean3yrVPD = mean(vpd.kPa.),
            mean3yrCWD = mean(def.mm.))

AnnualDeviation <- inner_join(AnnualAvgTerra,PostAnnual3yr)%>% 
  mutate("dev3yrVPD" = (mean3yrVPD - meanVPD)/sdVPD)%>% 
  mutate("dev3yrCWD" = (mean3yrCWD - meanCWD)/sdCWD)
```

## Growing Season Climate Variables: Max Temp, Min Temp, Precip, Soil Moisture

```{r}
#tmax.degC. 
#tmin.degC.
#ppt.mm.
#soil.mm.
GrowSeasonAvgTerra <- TerraData %>%
  filter(Month %in% c(4,5,6,7,8,9))%>%
  group_by(SiteID) %>% 
  summarize(meanTmax = mean(tmax.degC.), 
            sdTmax = sd(tmax.degC.), 
            meanTmin = mean(tmin.degC.), 
            sdTmin = sd(tmin.degC.),
            meanPrecip = mean(ppt.mm.),
            sdPrecip = sd(ppt.mm.),
            meanSoil = mean(soil.mm.), 
            sdSoil = sd(soil.mm.)) 

PostGrowTerra3yr <- TerraData %>%
  group_by(SiteID, Year)%>%
  filter(Year == 2019:2021 & Month %in% c(4,5,6,7,8,9))%>%
  group_by(SiteID)%>%
  summarize(mean3yrTmax = mean(tmax.degC.),
            mean3yrTmin = mean(tmin.degC.),
            mean3yrPrecip = mean(ppt.mm.),
            mean3yrSoil = mean(soil.mm.))

GrowDeviation <- inner_join(GrowSeasonAvgTerra,PostGrowTerra3yr)%>%
  mutate("dev3yrTmax" = (mean3yrTmax - meanTmax)/sdTmax)%>% 
  mutate("dev3yrTmin" = (mean3yrTmin - meanTmin)/sdTmin)%>% 
  mutate("dev3yrPrecip" = (mean3yrPrecip - meanPrecip)/sdPrecip)%>%
  mutate("dev3yrSoil"= (mean3yrSoil - meanSoil)/sdSoil)
  
```

## Data frame with deviations 

```{r}
ThesisTerra <- inner_join(AnnualDeviation, GrowDeviation)
 
```

## Full data frame with terraclimate and thesis data

```{r}


#Still need to figure out duplicate rows and NAs
ThesisAll <- merge(ThesisAll1, ThesisTerra, by.x = "PlotID", by.y = "SiteID", all = T)
  
```

## NMDS response data frames 

```{r}

ThesisNMDSResponse <- ThesisAll1 %>% 
  dplyr::select(PlotID, forest_type, gm_cover, fb_cover, sh_cover, tr_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total)%>% 
  mutate_at(vars(PIPO_total,ABLA_total,PIEN_total), as.numeric)

#Lower Montane NMDS
z_NMDSdf_LowerMontane <- ThesisNMDSResponse %>% 
  filter(forest_type == "Lower Montane")%>% 
  dplyr::select(!c(forest_type, PIAR_total, ABLA_total, PIEN_total)) %>% 
  mutate(across(gm_cover:PIFL_total, ~as.numeric(scale(.)), .names = 'z_{col}'))%>% 
  replace(is.na(.),0)%>% 
  filter(!PlotID %in% 'LS02')%>%
  remove_rownames %>% 
  column_to_rownames(var="PlotID")%>% 
   rename(
      "Graminoids" = z_gm_cover,
      "Forbs" = z_fb_cover,
      "Shrubs" = z_sh_cover,
      "Seedlings" = z_tr_cover,
      "POTR" = z_POTR_total,
      "QUGA" = z_QUGA_total,
      "RONE" = z_RONE_total,
      # "PIPO" = z_PIPO_total,
      "PSME" = z_PSME_total,
      "ABCO" = z_ABCO_total,
      "PICO" = z_PICO_total)%>%
      # "PIFL" = z_PIFL_total) 
  dplyr::select(!c(gm_cover, fb_cover, sh_cover, tr_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, z_PIPO_total,z_PIFL_total))
  
#Upper Montane NMDS  
z_NMDSdf_UpperMontane <- ThesisNMDSResponse %>% 
  filter(forest_type == "Upper Montane")%>% 
  dplyr::select(!c(forest_type)) %>% 
  mutate(across(gm_cover:PIEN_total, ~as.numeric(scale(.)), .names = 'z_{col}'))%>% 
  replace(is.na(.),0)%>% 
  remove_rownames %>% 
  column_to_rownames(var="PlotID")%>% 
   rename(
      "Graminoids" = z_gm_cover,
      "Forbs" = z_fb_cover,
      "Shrubs" = z_sh_cover,
      "Seedlings" = z_tr_cover,
      "POTR" = z_POTR_total,
      "QUGA" = z_QUGA_total,
      "RONE" = z_RONE_total,
      "PIPO" = z_PIPO_total,
      "PSME" = z_PSME_total,
      "ABCO" = z_ABCO_total,
      "PICO" = z_PICO_total,
      "PIFL" = z_PIFL_total,
      "PIAR" = z_PIAR_total,
      "ABLA" = z_ABLA_total,
      "PIEN" = z_PIEN_total)%>% 
  dplyr::select(!c(gm_cover, fb_cover, sh_cover, tr_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total))

#Subalpine NMDS
z_NMDSdf_Subalpine <- ThesisNMDSResponse %>% 
  filter(forest_type == "Subalpine")%>% 
  dplyr::select(!c(forest_type, QUGA_total, RONE_total, PIPO_total)) %>% 
  mutate(across(where(is.numeric),~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")%>%
   rename(
      "Graminoids" = z_gm_cover,
      "Forbs" = z_fb_cover,
      "Shrubs" = z_sh_cover,
      "Seedlings" = z_tr_cover,
      "POTR" = z_POTR_total,
      "PSME" = z_PSME_total,
      "ABCO" = z_ABCO_total,
      "PICO" = z_PICO_total,
      "PIFL" = z_PIFL_total,
      "PIAR" = z_PIAR_total,
      "ABLA" = z_ABLA_total,
      "PIEN" = z_PIEN_total)%>% 
  dplyr::select(!c(gm_cover, fb_cover, sh_cover, tr_cover, POTR_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total))

#Standardize by zscore for each forest type 
# z_NMDSResponse <- ThesisNMDSResponse %>% 
#   mutate(across(gm_cover:PIEN_total, ~as.numeric(scale(.)), .names = 'z_{col}'))%>% 
#   replace(is.na(.),0)%>% 
#   dplyr::select(!c(gm_cover, fb_cover, sh_cover, POTR_total, QUGA_total, RONE_total, PIPO_total, PSME_total, ABCO_total, PICO_total, PIFL_total, PIAR_total, ABLA_total, PIEN_total))%>% 
#   remove_rownames %>% 
#   column_to_rownames(var="PlotID")


#Rename columns with species 
# z_NMDSResponse1 <- ThesisNMDSResponse %>% 
#     rename(
#       "Graminoids" = z_gm_cover,
#       "Forbs" = z_fb_cover,
#       "Shrubs" = z_sh_cover,
#       "Seedlings" = z_tr_cover,
#       "POTR" = z_POTR_total,
#       "QUGA" = z_QUGA_total,
#       "RONE" = z_RONE_total,
#       "PIPO" = z_PIPO_total,
#       "PSME" = z_PSME_total,
#       "ABCO" = z_ABCO_total,
#       "PICO" = z_PICO_total,
#       "PIFL" = z_PIFL_total,
#       "PIAR" = z_PIAR_total,
#       "ABLA" = z_ABLA_total,
#       "PIEN" = z_PIEN_total)

```

## Overlay predictors data frames 

```{r}
#OVerlay predictors data frame 
OverlayPredictors1 <- ThesisAll1 %>% 
  # dplyr::select(PlotID, burn_sev_category, forest_type, field.elevation..m., slope...., aspect_rescaled, heat_load, canopy_cover, avg_seed_source, conifer_seed_source, bg_cover, lt_cover, wd_cover, rk_cover, total_ba, live_ba, dead_ba)%>% 
  dplyr::select(PlotID, burn_sev_category, forest_type, aspect_rescaled, heat_load, canopy_cover, conifer_seed_source, bg_cover, lt_cover, wd_cover, rk_cover, total_ba)%>% 
  rowwise()%>%
  mutate(barren_cover = sum(c(bg_cover,rk_cover)))%>% 
  mutate(organic_cover = sum(c(lt_cover,wd_cover)))%>% 
  dplyr::select(!c(bg_cover:rk_cover))

#Overlay Predictors Lower Montane 
OverlayPred_LowerMontane <- OverlayPredictors1 %>% 
  filter(forest_type == "Lower Montane")%>% 
  filter(!PlotID %in% 'LS02')%>%
  dplyr::select(!c(forest_type, barren_cover)) %>% 
  # mutate(across(canopy_cover:organic_cover,~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  # replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")
  # rename("Elevation" = field.elevation..m.,
  #        "Slope" = slope....,
  #        "Aspect" = aspect_rescaled,
  #        "Head Load Index" = heat_load,
  #        "Canopy Cover" = z_canopy_cover,
  #        "Adult Seed Source" = z_avg_seed_source,
  #        "Conifer Seed Source" = z_conifer_seed_source,
  #        "Barren Ground" = z_barren_cover,
  #        "Organic Cover" = z_organic_cover)


#Overlay Predictors Lower Montane 
OverlayPred_UpperMontane <- OverlayPredictors1 %>% 
  filter(forest_type == "Upper Montane")%>% 
  dplyr::select(!c(forest_type, barren_cover)) %>% 
  # mutate(across(canopy_cover:organic_cover,~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  # replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")
  # rename("Elevation" = field.elevation..m.,
  #        "Slope" = slope....,
  #        "Aspect" = aspect_rescaled,
  #        "Head Load Index" = heat_load,
  #        "Canopy Cover" = z_canopy_cover,
  #        "Adult Seed Source" = z_avg_seed_source,
  #        "Conifer Seed Source" = z_conifer_seed_source,
  #        "Barren Ground" = z_barren_cover,
  #        "Organic Cover" = z_organic_cover)



#Overlay Predictors Lower Montane 
OverlayPred_Subalpine <- OverlayPredictors1 %>% 
  filter(forest_type == "Subalpine")%>% 
  dplyr::select(!c(forest_type, canopy_cover, barren_cover)) %>% 
  # mutate(across(avg_seed_source:organic_cover,~as.numeric(scale(.)), .names = 'z_{col}')) %>%
  # replace(is.na(.),0)%>%
  remove_rownames %>%
  column_to_rownames(var="PlotID")
  # rename("Elevation" = field.elevation..m.,
  #        "Slope" = slope....,
  #        "Aspect" = aspect_rescaled,
  #        "Head Load Index" = heat_load,
  #        "Adult Seed Source" = z_avg_seed_source,
  #        "Conifer Seed Source" = z_conifer_seed_source,
  #        "Barren Ground" = z_barren_cover,
  #        "Organic Cover" = z_organic_cover)

```


## NMDS objects

```{r}
library(vegan)
library(ggvegan)
library(ggpubr)

#NMDS Lower Montane 
NMDS_LowerMontane <- metaMDS(z_NMDSdf_LowerMontane, distance = "euclidean", autotransform = F, wascores=T)
ordiplot(NMDS_LowerMontane, type="t", main = "Lower Montane")
str(NMDS_LowerMontane)
vegan:: stressplot(NMDS_LowerMontane)

plot(NMDS_LowerMontane, type = "n")
points(NMDS_LowerMontane, display = "sites", cex = 0.8, pch=21, col="red", bg="yellow")
points(NMDS_LowerMontane, display = "species", cex=0.7, col="blue")


#NMDS Upper Montane 
NMDS_UpperMontane <- metaMDS(z_NMDSdf_UpperMontane, distance = "euclidean", k=2, autotransform = F)
ordiplot(NMDS_UpperMontane, type = 't', main = "Upper Montane")
str(NMDS_UpperMontane)
vegan:: stressplot(NMDS_UpperMontane)

#NMDS Subalpine 
NMDS_Subalpine <- metaMDS(z_NMDSdf_Subalpine, distance = "euclidean", k=2, autotransform = F)
ordiplot(NMDS_Subalpine, type = 't', main = "Subalpine")
str(NMDS_Subalpine)
vegan:: stressplot(NMDS_Subalpine)

NMDS_LowerMontane

```

## Attempts to plot with ggvegan

```{r}
#Attempts to plot with ggvegan
autoplot(NMDS_LowerMontane)


```

## Fit environmental variables 

```{r}

#Lower Montane env fit 
EnvFit_LowerMontane <- envfit(NMDS_LowerMontane, OverlayPred_LowerMontane)
# plot(EnvFit_LowerMontane)
EnvFit_LowerMontane

#Upper Montane env fit 
EnvFit_UpperMontane <- envfit(NMDS_UpperMontane, OverlayPred_UpperMontane)
# plot(EnvFit_UpperMontane)
EnvFit_UpperMontane

#Subalpine env fit 
EnvFit_Subalpine <- envfit(NMDS_Subalpine, OverlayPred_Subalpine)
# plot(EnvFit_Subalpine)
EnvFit_Subalpine
```


# Monique code

```{r}

#relativize by row total (i.e. convert to percentage composition)
spp13_rowsums <- rowSums(seki_spp13)
seki_spp13_relrow <- seki_spp13/spp13_rowsums
head(seki_spp13_relrow)


#relativize by column maximum (downweight abundant species)
spp13_colmax<-sapply(seki_spp13,max)
seki_spp13_relcolmax <- sweep(seki_spp13,2,spp13_colmax,'/')
head(seki_spp13_relcolmax)
```


